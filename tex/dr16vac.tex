% e.g., http://adsabs.harvard.edu/abs/2014ApJ...790..127B

\documentclass[modern]{aastex62}
% \documentclass[twocolumn]{aastex62}
\usepackage{amsmath}

% Load common packages
% \usepackage{microtype}  % ALWAYS!
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{booktabs}

\usepackage{graphicx}
\usepackage{color}

\graphicspath{{figures/}}
\input{preamble.tex}

\shorttitle{Stuff}
\shortauthors{Price-Whelan et al.}

\begin{document}

\title{Stellar and substellar companions in APOGEE DR16: \\
       Catalog of XX systems}

\author[0000-0003-0872-7098]{Adrian~M.~Price-Whelan}
\affiliation{Center for Computational Astrophysics, Flatiron Institute,
             Simons Foundation, 162 Fifth Avenue, New York, NY 10010, USA}
\email{aprice-whelan@flatironinstitute.org}
\correspondingauthor{Adrian M. Price-Whelan}

% \author[0000-0003-2866-9403]{David~W.~Hogg}
% \affiliation{Max-Planck-Institut f\"ur Astronomie,
%              K\"onigstuhl 17, D-69117 Heidelberg, Germany}
% \affiliation{Center for Cosmology and Particle Physics,
%              Department of Physics,
%              New York University, 726 Broadway,
%              New York, NY 10003, USA}
% \affiliation{Center for Data Science,
%              New York University, 60 Fifth Ave,
%              New York, NY 10011, USA}
% \affiliation{Flatiron Institute,
%              Simons Foundation,
%              162 Fifth Avenue,
%              New York, NY 10010, USA}

% \author[0000-0003-4996-9069]{Hans-Walter~Rix}
% \affiliation{Max-Planck-Institut f\"ur Astronomie,
%              K\"onigstuhl 17, D-69117 Heidelberg, Germany}

\author{Others}

\begin{abstract}
% Context
Binary star systems provide key context and constraints for nearly all subfields in astrophysics, yet precise inferences about binary star populations typically rely on just hundreds of stars nearest to the sun.
Detailed knowledge of binary star population properties is therefore
% Aims
Contemporary stellar surveys already observe large numbers of stars
% Methods
We have a big hammer
% Results
We produce posterior samplings assuming...SB1 and two-body systems...
We also produce a catalog of binary systems...we select on evidence or parameter estimation...
% Conclusions
Binaries all over HR diagram...but we find ??
We find interesting low-mass and high-mass systems...
\end{abstract}

\keywords{}


\section{Introduction} \label{sec:intro}

A better understanding the population of binary stars throughout our galaxy is important for all aspects of astrophysics. For example, ... stellar-mass binary black hole mergers to stellar populations in high-redshift galaxies \citep[e.g.,][]{Breivik:2019, Rix:2019}.

We need to understand the population statistics of stellar multiplicity and their variations with stellar type, chemistry, and dynamical environment.

This problem spans a wide range of timescales, wavelengths, and many current and near-future stellar surveys (Gaia, APOGEE, LAMOST, SDSS-V, etc.) have the capacity to deliver samples of binary stars and stellar companions orders of magnitude larger than are presently known, throughout all stages of stellar evolution.
The dream: combine all if this and learn ...
This has only been comprehensively done for a sample of a few hundred stars in solar neighborhood.

As a step towards large-scale population inference, we focus here on multi-epoch spectroscopic data from the APOGEE surveys.
The challenge: data are often sparse, most individual systems are not determined uniquely.
We have machinery to generate full samplings over orbital parameters for radial velocity data, under the assumptions listed in The Joker paper (SB1, etc.).
We run this sampler on all of APOGEE DR16 with some quality cuts and release the resulting catalog of posterior samples, along with some summary metadata for unimodal / uniquely determined orbits.

We use these samples to infer the companion period-eccentricity distribution over the HR diagram as an initial demonstration of hierarchical inference.


\section{Data} \label{sec:data}

We primarily use spectroscopic data from data release 16 (\dr{16}) of the
\apogee\ surveys (\citealt{Majewski:2017, Abolfathi:2017, DR16}).
\apogee\ is a component of the Sloan Digital Sky Survey IV (\sdssiv;
\citealt{Gunn:2006, Blanton:2017}) and the main goal is to survey the chemical
and dynamical properties of stars across much of the Milky Way disk by obtaining
high-resolution ($R \sim 22,500$) infrared ($H$-band) spectroscopy of hundreds
of thousands of stars.
The primary survey targets are selected with simple color and magnitude cuts,
but the survey uses fiber-plugged plates that leads to extremely nonuniform
coverage of the Galactic stellar distribution (see, e.g., Figure~1 in
\citealt{DR16}).

\dr{16} is the first \sdss\ data release to contain \apogee\ data observed with
a clone of the \apogee\ spectrograph on the 2.5m du Point telescope at Las
Campanas Observatory, providing access to targets in the southern hemisphere.
For the first time, this data release also contains calibrated stellar
parameters for dwarf stars.
These two facts mean that \dr{16} contains nearly $3\times$ more sources with
calibrated stellar parameters than the previous public data release, \dr{14}
(see Section~4 of \citealt{DR16} for many more details about \apogee\ \dr{16}).

Most \apogee\ stars are observed multiple times in a set of time-resolved
``visits'' that are combined before determining stellar parameters and chemical
abundances.
While the visit spectra naturally provide time-domain velocity information about
sources, studying stellar multiplicity is not the primary goal of the survey:
The cadence and time baseline for a typical \apogee\ source is primarily
governed by trying to schedule a set number of visits determined by
signal-to-noise thresholds for the faintest targets in a given field.
A consequence of this strategy is that the time resolution and number of visits
for the vast majority of \apogee\ sources in \dr{16} is not sufficient for fully
determining companion orbital properties, as illustrated below.

\subsection{Quality cuts and defining a parent sample}

The primary goal of the catalog released with this \documentname\ is to provide
posterior samplings in Keplerian orbital parameters for all high-quality
\apogee\ sources in \dr{16} with multiple, well-measured radial velocities.
We therefore impose a set of quality cuts to sub-select \apogee\ \dr{16} sources
by rejecting sources or visits using the following \apogee\
bitmasks\footnote{https://www.sdss.org/dr16/algorithms/bitmasks/}:
\begin{itemize}
    \item Source-level (\texttt{allStar}) \texttt{STARFLAG} must not contain \texttt{VERY\_BRIGHT\_NEIGHBOR}, \texttt{SUSPECT\_RV\_COMBINATION} (bitmask value: 65544)
    \item Source-level (\texttt{allStar}) \texttt{ASPCAPFLAG} must not contain \texttt{TEFF\_BAD}, \texttt{LOGG\_BAD}, \texttt{VMICRO\_BAD}, \texttt{ROTATION\_BAD}, \texttt{VSINI\_BAD} (bitmask value: 1141309440)
    \item Visit-level (\texttt{allVisit}) \texttt{STARFLAG} must not contain \texttt{VERY\_BRIGHT\_NEIGHBOR}, \texttt{SUSPECT\_RV\_COMBINATION}, \texttt{LOW\_SNR}, \texttt{PERSIST\_HIGH}, \texttt{PERSIST\_JUMP\_POS}, \texttt{PERSIST\_JUMP\_NEG} (bitmask value: 78360)
\end{itemize}
These bitmasks are designed to remove the most obvious data reduction or
calibration failures that would directly impact the visit-level radial velocity
determinations.
However, we later impose a stricter set of quality masks when showing results in
\sectionname~\ref{sec:TODO}.
After applying the above masks, we additionally reject any source with $<3$
visits.
Our final parent sample contains $232,531$ unique sources, selected from the
$437,485$ unique sources in all of \apogee\ \dr{16}.
Of the $\approx$$200,000$ sources removed, the vast majority were dropped
because they had $<3$ visits ($\approx$$17,000$ were removed by the quality
cuts).

% Notebook: Figure-DR16-statistics.ipynb
\begin{figure}[!t]
\begin{center}
\includegraphics[width=0.7\textwidth]{specHR.pdf}
\end{center}
\caption{%
Two spectroscopic stellar parameters---effective temperature, $T_{\rm eff}$, and
log-surface gravity, $\log g$---of \apogee\ \dr{16} sources that pass our
quality cuts; These sources represent our ``parent sample.''
The pixel coloring indicates the number of sources in each bin of stellar
parameters.
The outlined regions roughly identify the red giant branch (upper polygon,
blue), subgiant branch (middle polygon, black), and (FGK-type) main sequence
(lower polygon, green).
The numbers next to each selection polygon indicate the number of sources in
each.
\label{fig:specHR}
}
\end{figure}

% Notebook: Figure-DR16-statistics.ipynb
\begin{figure}[!t]
\begin{center}
\includegraphics[width=1\textwidth]{visitstats.pdf}
\end{center}
\caption{%
Some statistics of \apogee\ \dr{16} visits.
\textbf{Left:} The number of sources with more than a given number of visits,
$n_{\rm vis}$.
While $\approx$$50\%$ of sources have 3 visits, ($114,263$, $57,593$, $15,862$)
sources have $> (3, 5, 10)$ visits, respectively.
A very small number of sources have $>50$ visits.
\textbf{Right:} The number of sources with a time baseline, $\tau$, longer than
given (on the horizontal axis).
While $\approx$$50\%$ of sources have a time baseline $\tau \lesssim 56~{\rm
day}$, ($88,737$, $9,743$) sources have $\tau > (100, 1000)~{\rm days}$.
\label{fig:visitstats}
}
\end{figure}

Figure~\ref{fig:specHR} shows the number of sources in our parent sample---i.e.
\apogee\ sources with 3 or more visits that pass the quality cuts described
above---as a function of spectroscopic stellar parameters $T_{\rm eff}$,
effective temperature, and $\log g$, log-surface gravity.
While the majority of sources appear to be giant-branch stars ($>150,000$), a
substantial number of main sequence stars are present ($>60,000$) thanks to the
\apogee\ data reduction pipeline improvements for \dr{16}.
Figure~\ref{fig:visitstats} shows some statistics about the time coverage of the
visits for sources in our parent sample.
About half of the sources have a small number of visits spread over a small time
baseline: $50\%$ of sources have $<5$ visits over $<100~{\rm days}$.
About $7\%$ of sources ($15,366$) have $\geq 10$ visits over $\geq 100~{\rm
days}$.


\subsection{Visit velocity uncertainty calibration} \label{sec:visitcalib}

The significance of radial velocity variations, especially for low-mass or
long-period companions, will depend strongly on the correctness of the visit
velocity measurement errors.
However, the catalog-level \apogee\ visit velocity errors (\texttt{VRELERR} in
the \texttt{allVisit} file) are known to be underestimated (e.g.,
\citealt{Cottaar:2014}, Nidever et al., in prep.).
By comparing the visit velocity scatter ...
Globally, the visit uncertainties are roughly underestimated by a factor of
$\approx$2.5, with a noise floor of $\approx 72~\mps$.

For example,
In what follows, we therefore scale (up) the visit velocity errors according to the

Describe exoplanet survey crossmatch and calibration bullshit.

This ends up being conservative: we effectively force low SNR visit to a SNR-dependent threshold rv err, high SNR stars get adjusted too with a global floor to RV error.

Figure: raw visit errors vs. SNR and then adjusted visit errors


\section{Methods} \label{sec:methods}

As illustrated above, a large number of sources in \apogee\ \dr{16} have few
visits that span a short time baseline.
For most sources, we therefore expect that even if visit-level radial velocity
variations are detected with high significance, the companion orbital parameters
will be very uncertain---i.e. the posterior probability distribution function
(\textsl{pdf}) over orbital parameters will generally be very multi-modal
\citep[e.g.,][]{TODO, thejoker}.
Still, in unison, or within the context of a hierarchical model that utilizes
the individual posterior samplings, the combination of all of these individually
weakly-constrained binary star orbits should still provide information about the
population of binary stars.
We have previously designed and implemented a custom Monte Carlo sampler for
precisely this problem: \thejoker\ \citep{thejoker}.
\thejoker\ is designed to deliver converged posterior samplings over Keplerian
orbital parameters given radial velocity observations, even when the
observations are sparse or very noisy.
We have previously applied \thejoker\ to \apogee\ \dr{14}
\citep{Price-Whelan:2018} and, by making some conservative selections with the
returned samplings, released a catalog of over $5,000$ binary star systems;
This \documentname\ and companion catalog is a successor to this previous work.

\subsection{Updates to \thejoker}

Major improvements:
- new prior on K - kind of a bug fix
- MCMC with pymc3 + exoplanet (NUTS)
- random indices

Describe robust constant fit stuff.


\subsection{Caveats and assumptions} \label{sec:caveats}

Where we will fail:

Systems with large systemic velocity (dwarf satellites)

Triple systems


\subsection{Running on all of \apogee\ \dr{16}} \label{sec:rundr16}

Parameter choices

Implementation details

Some statistics about the run: how many unimodal, bimodal.

\section{A catalog of binary stars} \label{sec:catalog}

Any catalog will have some arbitrary cuts. Here we cut on likelihood ratio of binary star model vs. constant model (not fully marginal likelihoods, so cut won't be at 0!).

We find XX stars with companions - show simple plots over HR diagram for cuteness.

Gold sample: phase coverage statistics?

TODO: what about bimodal samplings, or samplings with small range in ln-period?

Discuss RGB vs. MS primaries differently

Figure: Some cute examples

Figure: Fraction of stars with companions over HR diagram

\section{Inferring shit with a hierarchical model} \label{sec:Pe}

\begin{align}
    z &= \ln\,P\\
    \bs{\theta} &= (z, e)\\
    \bs{\alpha} &= (k, z_0, \alpha_0)\\
    p(\bs{\theta} \given \bs{\alpha}) &= p(z) \, p(e \given z)\\
    p(z) &= \norm\left(z \given \mu_z, \sigma_z^2 \right)\\
    p(e \given z) &= \alpha(z) \, p_1(e) + (1-\alpha(z)) \, p_2(e)\\
    f(z\,;\,k,z_0) &= \frac{1}{1 + e^{-k\,(z - z_0)}}\\
    \alpha(z \,;\, k, z_0, \alpha_0) &= (1-\alpha_0) \, f(z \,;\, k, z_0) + \alpha_0\\
    p_1(e) &= B(e \given a_1, b_1)\\
    p_2(e) &= B(e \given a_2, b_2)
\end{align}

\begin{align}
    p(D \given \bs{\alpha}) &= \int \dd\bs{\theta} \,
        p(D \given \bs{\theta}) \, p(\bs{\theta} \given \bs{\alpha})\\
    &\approx \frac{\mathcal{Z}}{K} \sum_k^K
        \frac{p(\bs{\theta}_k \given \bs{\alpha})}
            {p(\bs{\theta}_k \given \bs{\alpha}_0)}\\
    \bs{\theta}_k &\sim p(\bs{\theta} \given D, \bs{\alpha}_0)
\end{align}

- Period, eccentricity distributions
- Mass-ratio distribution
     - Use C,N abundances for RGB and logg, teff, fe/h for main sequence
     - Calibrate against asteroseismology / APOKASC


Lars: "Any idea of the incidence of stars which did an engulfment on their way UP the RGB from the Luminosity of the clump to that of the RGB TIP? "

% Note: some or all of these may be broken out into separate papers!

% \subsection{Companions along the RGB}
% Compare RGB vs. RC - see engulfment?
%
% \subsection{Brown dwarfs}
% So many!
%
% \subsection{Binary population statistics}
% Simple hierarchical inference?
%
% \subsection{TRGB asteroseismology}
%
% \subsection{Binary star populations in open clusters}
%
% \subsection{Binary star populations in globular clusters}

% Ack: Lars Bildsten

\acknowledgements

It is a pleasure to thank
Lars Bildsten (KITP)
Dan Foreman-Mackey (Flatiron),
...
% We thank the anonymous referee for constructive comments that improved this
% manuscript.

Funding for the Sloan Digital Sky Survey IV has been provided by the Alfred P.
Sloan Foundation, the U.S. Department of Energy Office of Science, and the
Participating Institutions. SDSS-IV acknowledges support and resources from the
Center for High-Performance Computing at the University of Utah. The SDSS web
site is www.sdss.org.

SDSS-IV is managed by the Astrophysical Research Consortium for the
Participating Institutions of the SDSS Collaboration including the Brazilian
Participation Group, the Carnegie Institution for Science, Carnegie Mellon
University, the Chilean Participation Group, the French Participation Group,
Harvard-Smithsonian Center for Astrophysics, Instituto de Astrof\'isica de
Canarias, The Johns Hopkins University, Kavli Institute for the Physics and
Mathematics of the Universe (IPMU) / University of Tokyo, Lawrence Berkeley
National Laboratory, Leibniz Institut f\"ur Astrophysik Potsdam (AIP),
Max-Planck-Institut f\"ur Astronomie (MPIA Heidelberg), Max-Planck-Institut
f\"ur Astrophysik (MPA Garching), Max-Planck-Institut f\"ur Extraterrestrische
Physik (MPE), National Astronomical Observatories of China, New Mexico State
University, New York University, University of Notre Dame, Observat\'ario
Nacional / MCTI, The Ohio State University, Pennsylvania State University,
Shanghai Astronomical Observatory, United Kingdom Participation Group,
Universidad Nacional Aut\'onoma de M\'exico, University of Arizona, University
of Colorado Boulder, University of Oxford, University of Portsmouth, University
of Utah, University of Virginia, University of Washington, University of
Wisconsin, Vanderbilt University, and Yale University.


\software{
    Astropy \citep{astropy, astropy:2018},
    exoplanet \citep{exoplanet:exoplanet},
    gala \citep{gala},
    IPython \citep{ipython},
    numpy \citep{numpy},
    pymc3 \citep{Salvatier2016},
    schwimmbad \citep{schwimmbad:2017},
    scipy \citep{scipy},
    thejoker \citep{thejoker}
}

\bibliographystyle{aasjournal}
\bibliography{dr16vac}

\end{document}
